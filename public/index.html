<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedAdhere Pro - Agentic System Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .loading { animation: pulse-slow 2s ease-in-out infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold text-indigo-900 mb-3">üíä MedAdhere Pro</h1>
            <p class="text-xl text-gray-700">AI-Powered Medication Adherence System</p>
            <p class="text-sm text-gray-600 mt-2">Multi-Agent Workflow with MedGemma Medical LLM</p>
        </div>

        <!-- System Status -->
        <div id="systemStatus" class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üîß System Status</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-3xl mb-2">ü§ñ</div>
                    <div class="text-sm text-gray-600">Agents</div>
                    <div id="agentCount" class="text-2xl font-bold text-indigo-600">-</div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-3xl mb-2">‚öïÔ∏è</div>
                    <div class="text-sm text-gray-600">MedGemma</div>
                    <div id="medgemmaStatus" class="text-2xl font-bold text-green-600">-</div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-3xl mb-2">üî•</div>
                    <div class="text-sm text-gray-600">Firebase</div>
                    <div id="firebaseStatus" class="text-2xl font-bold text-orange-600">-</div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-3xl mb-2">üìä</div>
                    <div class="text-sm text-gray-600">Workflows</div>
                    <div id="workflowCount" class="text-2xl font-bold text-purple-600">0</div>
                </div>
            </div>
        </div>

        <!-- Scenarios -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üé¨ Demo Scenarios</h2>
            <div class="grid md:grid-cols-3 gap-4">
                <!-- Scenario 1 -->
                <div class="border-2 border-indigo-200 rounded-lg p-5 hover:border-indigo-400 transition">
                    <div class="text-4xl mb-3 text-center">‚è∞</div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Scenario 1: Timing Conflict</h3>
                    <p class="text-sm text-gray-600 mb-4">Patient confused about when to take multiple medications. MedGemma creates optimized schedule.</p>
                    <button onclick="runScenario(1)" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                        Run Scenario
                    </button>
                </div>

                <!-- Scenario 2 -->
                <div class="border-2 border-green-200 rounded-lg p-5 hover:border-green-400 transition">
                    <div class="text-4xl mb-3 text-center">üíä</div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Scenario 2: Supplement Interference</h3>
                    <p class="text-sm text-gray-600 mb-4">Patient taking supplements that block medication. MedGemma detects interference and adjusts timing.</p>
                    <button onclick="runScenario(2)" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                        Run Scenario
                    </button>
                </div>

                <!-- Scenario 3 -->
                <div class="border-2 border-red-200 rounded-lg p-5 hover:border-red-400 transition">
                    <div class="text-4xl mb-3 text-center">‚ö†Ô∏è</div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Scenario 3: Side Effects</h3>
                    <p class="text-sm text-gray-600 mb-4">Patient experiences nausea. MedGemma assesses severity and suggests taking with food.</p>
                    <button onclick="runScenario(3)" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                        Run Scenario
                    </button>
                </div>
            </div>
        </div>

        <!-- Workflow Display -->
        <div id="workflowSection" class="bg-white rounded-lg shadow-lg p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">üîÑ Workflow Execution</h2>
                <span id="workflowId" class="text-sm text-gray-500"></span>
            </div>

            <!-- Progress Bar -->
            <div id="progressBar" class="mb-6">
                <div class="flex justify-between mb-2">
                    <span class="text-sm font-semibold text-gray-700">Progress</span>
                    <span id="progressText" class="text-sm text-gray-600">0/5 agents</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progressFill" class="bg-indigo-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>

            <!-- Workflow Summary -->
            <div id="workflowSummary" class="mb-6 bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-lg p-5 hidden">
                <h3 class="text-xl font-bold text-indigo-900 mb-3">üéØ Intelligent Summary</h3>
                <p id="summaryText" class="text-gray-800 mb-4 leading-relaxed text-base"></p>
                
                <div class="grid md:grid-cols-4 gap-3 mt-4">
                    <div class="bg-white rounded-lg p-3 border-l-4 border-indigo-500">
                        <div class="text-xs text-gray-500 mb-1">Risk Level</div>
                        <div id="summaryRisk" class="text-lg font-bold">-</div>
                    </div>
                    <div class="bg-white rounded-lg p-3 border-l-4 border-purple-500">
                        <div class="text-xs text-gray-500 mb-1">Adherence Rate</div>
                        <div id="summaryAdherence" class="text-lg font-bold text-purple-600">-</div>
                    </div>
                    <div class="bg-white rounded-lg p-3 border-l-4 border-blue-500">
                        <div class="text-xs text-gray-500 mb-1">AI Consults</div>
                        <div id="summaryConsults" class="text-lg font-bold text-blue-600">-</div>
                    </div>
                    <div class="bg-white rounded-lg p-3 border-l-4 border-green-500">
                        <div class="text-xs text-gray-500 mb-1">Actions Taken</div>
                        <div id="summaryActions" class="text-lg font-bold text-green-600">-</div>
                    </div>
                </div>

                <!-- Key Insights Cards -->
                <div id="insightsCards" class="mt-4 grid md:grid-cols-2 gap-3">
                    <!-- Will be populated -->
                </div>

                <!-- Expandable Deep Dive -->
                <button onclick="toggleDeepDive()" class="mt-4 w-full bg-indigo-100 hover:bg-indigo-200 text-indigo-800 px-4 py-2 rounded-lg transition text-sm font-semibold">
                    <span id="deepDiveToggle">‚ñº Show Detailed Analysis</span>
                </button>
                <div id="deepDiveContent" class="hidden mt-3 space-y-3 text-sm">
                    <!-- Will be populated with agent-specific insights -->
                </div>
            </div>

            <!-- Agent Results -->
            <div id="agentResults" class="space-y-4">
                <!-- Will be populated dynamically -->
            </div>

            <!-- Reasoning Trace -->
            <div id="reasoningTrace" class="mt-6 bg-gray-50 rounded-lg p-4">
                <h3 class="text-lg font-bold text-gray-800 mb-3">üí≠ Reasoning Trace</h3>
                <div id="reasoningContent" class="space-y-1 text-sm font-mono">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:8000' 
            : 'https://us-central1-medadhere-pro.cloudfunctions.net';

        const scenarios = {
            1: {
                patient_id: "p001",
                action: "skipped",
                reason: "timing_conflict",
                medication_id: "med_levothyroxine_50mcg",
                notes: "Too confusing - don't know when to take thyroid med vs calcium vs metformin"
            },
            2: {
                patient_id: "p002",
                action: "skipped",
                reason: "supplement_interference",
                medication_id: "med_levothyroxine_50mcg",
                notes: "Good adherence but labs worsening - recently started calcium and iron supplements"
            },
            3: {
                patient_id: "p003",
                action: "took",
                reason: "side_effects",
                medication_id: "med_metformin_500mg",
                notes: "Feeling nauseous after taking"
            }
        };

        // Load system status on page load
        window.onload = async () => {
            await loadSystemStatus();
            await loadWorkflows();
        };

        async function loadSystemStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                
                document.getElementById('agentCount').textContent = data.agents?.count || 0;
                document.getElementById('medgemmaStatus').textContent = data.agents?.count > 0 ? '‚úì' : '‚úó';
                document.getElementById('firebaseStatus').textContent = data.firebase_configured ? '‚úì' : '‚úó';
            } catch (error) {
                console.error('Failed to load system status:', error);
            }
        }

        async function loadWorkflows() {
            try {
                const response = await fetch(`${API_BASE}/api/workflows`);
                const data = await response.json();
                document.getElementById('workflowCount').textContent = data.count || 0;
            } catch (error) {
                console.error('Failed to load workflows:', error);
            }
        }

        async function runScenario(scenarioNum) {
            const scenario = scenarios[scenarioNum];
            const timestamp = new Date().toISOString();
            
            // Show workflow section
            document.getElementById('workflowSection').classList.remove('hidden');
            document.getElementById('workflowSummary').classList.add('hidden');
            document.getElementById('agentResults').innerHTML = '<div class="text-center loading text-gray-500">üîÑ Starting workflow...</div>';
            document.getElementById('reasoningContent').innerHTML = '';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = '0/5 agents';

            try {
                const response = await fetch(`${API_BASE}/api/patient-action`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...scenario, timestamp })
                });

                const data = await response.json();

                if (data.workflow_id) {
                    document.getElementById('workflowId').textContent = `Workflow: ${data.workflow_id}`;
                    
                    // For async workflows, poll for status
                    if (!data.result) {
                        pollWorkflowStatus(data.workflow_id);
                    } else {
                        displayWorkflowResult(data.result);
                    }
                } else {
                    document.getElementById('agentResults').innerHTML = '<div class="text-yellow-600">‚ö†Ô∏è Action logged but no workflow triggered</div>';
                }

                await loadWorkflows();
            } catch (error) {
                console.error('Error running scenario:', error);
                document.getElementById('agentResults').innerHTML = `<div class="text-red-600">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function pollWorkflowStatus(workflowId) {
            const maxAttempts = 90;  // 180 seconds for MedGemma processing
            let attempts = 0;

            const poll = setInterval(async () => {
                attempts++;
                try {
                    const response = await fetch(`${API_BASE}/api/workflow-status/${workflowId}`);
                    const data = await response.json();

                    if (data.status === 'completed' && data.result) {
                        clearInterval(poll);
                        displayWorkflowResult(data.result);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(poll);
                        document.getElementById('agentResults').innerHTML = '<div class="text-yellow-600">‚è±Ô∏è Workflow taking longer than expected...</div>';
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000);
        }

        function displayWorkflowResult(result) {
            const agents = result.agents_executed || [];
            const completed = agents.filter(a => a.status === 'success').length;
            const progress = (completed / 5) * 100;

            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `${completed}/5 agents completed`;

            // Display intelligent workflow summary
            if (result.summary) {
                const summary = result.summary;
                document.getElementById('workflowSummary').classList.remove('hidden');
                document.getElementById('summaryText').textContent = summary.summary_text || 'Workflow completed successfully.';
                
                // Set risk level with color and icon
                const riskElement = document.getElementById('summaryRisk');
                const riskIcons = { 'low': '‚úÖ', 'medium': '‚ö†Ô∏è', 'high': 'üö®', 'critical': 'üî¥' };
                const riskIcon = riskIcons[summary.risk_level?.toLowerCase()] || '‚ùì';
                riskElement.innerHTML = `${riskIcon} ${summary.risk_level || 'Unknown'}`;
                const riskColors = { 'low': 'text-green-600', 'medium': 'text-yellow-600', 'high': 'text-red-600', 'critical': 'text-red-800' };
                riskElement.className = `text-lg font-bold ${riskColors[summary.risk_level?.toLowerCase()] || 'text-gray-600'}`;
                
                // Adherence rate with visual indicator
                const adherenceEl = document.getElementById('summaryAdherence');
                const adherence = summary.adherence_rate || 0;
                const adherenceColor = adherence >= 80 ? 'text-green-600' : adherence >= 60 ? 'text-yellow-600' : 'text-red-600';
                adherenceEl.innerHTML = `${adherence}%`;
                adherenceEl.className = `text-lg font-bold ${adherenceColor}`;
                
                document.getElementById('summaryConsults').textContent = summary.medgemma_consultations || 0;
                document.getElementById('summaryActions').textContent = summary.interventions_count || 0;
                
                // Create insight cards
                let cardsHTML = '';
                
                if (summary.key_findings && summary.key_findings.length > 0) {
                    cardsHTML += `
                        <div class="bg-white rounded-lg p-3 border-l-4 border-blue-500">
                            <div class="flex items-center mb-2">
                                <span class="text-2xl mr-2">üîç</span>
                                <strong class="text-blue-800">Key Finding</strong>
                            </div>
                            <p class="text-gray-700 text-sm">${summary.key_findings[0]}</p>
                        </div>
                    `;
                }
                
                if (summary.recommended_actions && summary.recommended_actions.length > 0) {
                    cardsHTML += `
                        <div class="bg-white rounded-lg p-3 border-l-4 border-green-500">
                            <div class="flex items-center mb-2">
                                <span class="text-2xl mr-2">üí°</span>
                                <strong class="text-green-800">Top Action</strong>
                            </div>
                            <p class="text-gray-700 text-sm">${summary.recommended_actions[0]}</p>
                        </div>
                    `;
                }
                
                document.getElementById('insightsCards').innerHTML = cardsHTML;
                
                // Build deep dive content
                let deepDiveHTML = '';
                
                if (summary.key_findings && summary.key_findings.length > 0) {
                    deepDiveHTML += '<div class="bg-white rounded-lg p-3 border-l-4 border-blue-400">';
                    deepDiveHTML += '<strong class="text-blue-800">üîç Investigation Findings:</strong>';
                    deepDiveHTML += '<ul class="list-disc ml-5 mt-2 space-y-1">';
                    summary.key_findings.forEach(finding => {
                        deepDiveHTML += `<li class="text-gray-700">${finding}</li>`;
                    });
                    deepDiveHTML += '</ul></div>';
                }
                
                if (summary.recommended_actions && summary.recommended_actions.length > 0) {
                    deepDiveHTML += '<div class="bg-white rounded-lg p-3 border-l-4 border-green-400">';
                    deepDiveHTML += '<strong class="text-green-800">‚úÖ Remediation Actions:</strong>';
                    deepDiveHTML += '<ul class="list-disc ml-5 mt-2 space-y-1">';
                    summary.recommended_actions.forEach(action => {
                        deepDiveHTML += `<li class="text-gray-700">${action}</li>`;
                    });
                    deepDiveHTML += '</ul></div>';
                }
                
                if (summary.learning_insights && summary.learning_insights.length > 0) {
                    deepDiveHTML += '<div class="bg-white rounded-lg p-3 border-l-4 border-purple-400">';
                    deepDiveHTML += '<strong class="text-purple-800">üìö AI Learning Insights:</strong>';
                    deepDiveHTML += '<ul class="list-disc ml-5 mt-2 space-y-1">';
                    summary.learning_insights.forEach(insight => {
                        deepDiveHTML += `<li class="text-gray-700">${insight}</li>`;
                    });
                    deepDiveHTML += '</ul></div>';
                }
                
                if (summary.risk_approved !== undefined) {
                    const approvalIcon = summary.risk_approved ? '‚úÖ' : '‚ö†Ô∏è';
                    const approvalText = summary.risk_approved ? 'All interventions medically approved' : 'Requires physician review';
                    const approvalColor = summary.risk_approved ? 'border-green-400' : 'border-yellow-400';
                    deepDiveHTML += `<div class="bg-white rounded-lg p-3 border-l-4 ${approvalColor}">`;
                    deepDiveHTML += `<strong class="text-gray-800">${approvalIcon} Medical Safety:</strong>`;
                    deepDiveHTML += `<p class="text-gray-700 mt-1">${approvalText}</p></div>`;
                }
                
                deepDiveHTML += `<div class="bg-gray-50 rounded-lg p-3">`;
                deepDiveHTML += `<strong class="text-gray-800">üìä Workflow Metrics:</strong>`;
                deepDiveHTML += `<div class="mt-2 grid grid-cols-2 gap-2 text-xs">`;
                deepDiveHTML += `<div>Total Reasoning Steps: <strong>${summary.total_reasoning_steps || 0}</strong></div>`;
                deepDiveHTML += `<div>Agents Executed: <strong>${summary.agents_completed || 0}/${summary.total_agents || 0}</strong></div>`;
                deepDiveHTML += `<div>Pattern Detected: <strong>${summary.pattern_detected ? 'Yes' : 'No'}</strong></div>`;
                deepDiveHTML += `<div>Status: <strong>${summary.execution_status || 'Completed'}</strong></div>`;
                deepDiveHTML += `</div></div>`;
                
                document.getElementById('deepDiveContent').innerHTML = deepDiveHTML;
            }

            // Display agent results
            const agentHTML = agents.map(agent => {
                const statusIcon = agent.status === 'success' ? '‚úÖ' : '‚ùå';
                const statusColor = agent.status === 'success' ? 'border-green-300' : 'border-red-300';
                
                return `
                    <div class="border-2 ${statusColor} rounded-lg p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-bold text-gray-800">${statusIcon} ${agent.agent_type.replace('_', ' ').toUpperCase()}</h3>
                            <span class="text-xs text-gray-500">${agent.execution_time_ms || 0}ms</span>
                        </div>
                        ${agent.error ? `<p class="text-red-600 text-sm">${agent.error}</p>` : ''}
                        ${agent.result?.medgemma_consulted !== undefined ? `
                            <p class="text-sm text-gray-600 mt-2">
                                MedGemma Consulted: <strong>${agent.result.medgemma_consulted ? '‚úì Yes' : '‚úó No'}</strong>
                            </p>
                        ` : ''}
                    </div>
                `;
            }).join('');

            document.getElementById('agentResults').innerHTML = agentHTML;

            // Display reasoning trace
            if (result.reasoning_trace) {
                const reasoningHTML = result.reasoning_trace.map(step => 
                    `<div class="text-gray-700">${step}</div>`
                ).join('');
                document.getElementById('reasoningContent').innerHTML = reasoningHTML;
            }
        }

        function toggleDeepDive() {
            const content = document.getElementById('deepDiveContent');
            const toggle = document.getElementById('deepDiveToggle');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                toggle.textContent = '‚ñ≤ Hide Detailed Analysis';
            } else {
                content.classList.add('hidden');
                toggle.textContent = '‚ñº Show Detailed Analysis';
            }
        }
    </script>
</body>
</html>
